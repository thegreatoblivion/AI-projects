// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © orangesandjuice

//@version=6
strategy("Pullback Buy", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)
stopLoss = input.float(2.0, "Stop Loss (%)", minval=0.1, step=0.1)
takeProfit = input.float(4.0, "Take Profit (%)", minval=0.1, step=0.1)
sma200 = ta.sma(close, 200)
sma50 = ta.sma(close, 50)
sma20 = ta.sma(close, 20)
volumeAverage = ta.sma(volume, 50)
volume1Average = ta.sma(volume[1], 50)
volume2Average = ta.sma(volume[2], 50)

strongUptrend = close > sma200 and close > sma50 and close > sma20
isDecreasing = close[1] > close and close[2] > close[1] and close[3] > close[2] //if closing price decreases day after day
isVolumeLow = volume  < volumeAverage and volume[1] <volume1Average and volume[2] < volume2Average //previous 2 days low volume
longPosition = strongUptrend and isDecreasing and isVolumeLow
//distribution day stuff
is_down_bar = close-close[1] < (close[1] * -0.002) ? true : false
is_volume_up = volume - volume[1] > 0 ? true : false
is_distribution = is_down_bar and is_volume_up ? true : false
distributionDays = array.new<int>(20, 0)

distributionDays.remove(0)

if(is_distribution)
    distributionDays.push(1)
else 
    distributionDays.push(0)

if (longPosition)
    strategy.entry("Long", strategy.long)
    strategy.exit("Long Exit", "Long", stop=close * (1 - stopLoss / 100), limit=close * (1 + takeProfit / 100))
if (distributionDays.sum() >= 4)
    strategy.close("Long", "distribution day closed")

plotshape(longPosition, title="Buy Signal", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)

